---
title: "Distinct transcriptomic profiles of na√Øve CD4+ T cells distinguish HIV-1 infected patients initiating antiretroviral therapy at acute or chronic phase of infection"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Load required packages:
```{r}
library(DESeq2)
library(readxl)
require(scales)
library(cowplot)
library(tidyverse)
library(org.Hs.eg.db)
library(EnhancedVolcano)
library(eulerr)
library(hrbrthemes)
library(ggthemes)
library(extrafont)
library(clusterProfiler)
library(clusterProfiler.dplyr)
library(DOSE)
library(seriation)
library(Boruta)
library(fgsea)
library(gage)
library('Homo.sapiens')
library(WGCNA)
library(corrr)
library(gplots)
library(RColorBrewer)
```

Load raw counts data/metadata:
```{r}
countData <- as.matrix(read.csv('degData_naive.csv', sep = ';', row.names = 'gene_id'))
metaData <- read.csv('colData_naive.csv', sep = ';', row.names = 1)
metaData <- metaData[,c("cellType","condition")]
metaData$condition <- factor(metaData$condition)
metaData$cellType <- factor(metaData$cellType)
colnames(countData) <- sub("X", "", colnames(countData))
all(rownames(metaData) == colnames(countData))
```


Construct DESEQDataSet Object
```{r}
dds <- DESeqDataSetFromMatrix(countData = countData, 
                              colData = metaData, 
                              design =  ~ cellType + cellType:condition)

dds$group <- factor(paste0(dds$cellType, dds$condition))
design(dds) <- ~ group

dds <- DESeq(dds)
resultsNames(dds)

# Results for Naive CD4 T cells
N_LA_v_C <- results(dds, contrast=c("group", "NTCLate.Treated", "NTCControl"), tidy = T)
N_EA_v_C<- results(dds, contrast=c("group", "NTCEarly.Treated", "NTCControl"), tidy = T)
N_EA_v_LA <- results(dds, contrast=c("group","NTCEarly.Treated","NTCLate.Treated"), tidy = T)
```

Volcano plot of DEGs between naive CD4+ T cells of Early treated (EA) and controls (C)
```{r}
# ENSEMBL annotation
ens2symbol <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_C$row, 
                                    columns="SYMBOL",
                                    keytype="ENSEMBL")
# UNIPROT annotation
ens2uniprot <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_C$row,
                                    columns="UNIPROT",
                                    keytype="ENSEMBL")

# ENTREZ annotation
ens2entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_C$row,
                                    columns="ENTREZID",
                                    keytype="ENSEMBL")

ens2symbol <- as_tibble(ens2symbol)
ens2uniprot <- as_tibble(ens2uniprot)
ens2entrez <- as_tibble(ens2entrez)

N_EA_v_C <- inner_join(N_EA_v_C, ens2symbol, by=c("row"="ENSEMBL"))
N_EA_v_C <- N_EA_v_C %>% na.omit()
N_EA_v_C <- N_EA_v_C[!duplicated(N_EA_v_C$SYMBOL), ]

# PROTEIN CODING GENES
N_EA_v_C_uniprot <- inner_join(N_EA_v_C, ens2uniprot, by=c("row"="ENSEMBL"))
N_EA_v_C_uniprot <- N_EA_v_C_uniprot %>% na.omit()
N_EA_v_C_uniprot <- N_EA_v_C_uniprot[!duplicated(N_EA_v_C_uniprot$SYMBOL), ]

# ENTREZ
N_EA_v_C_entrez <- inner_join(N_EA_v_C, ens2entrez, by=c("row"="ENSEMBL"))
N_EA_v_C_entrez <- N_EA_v_C_entrez %>% na.omit()
N_EA_v_C_entrez <- N_EA_v_C_entrez[!duplicated(N_EA_v_C_entrez$SYMBOL), ]


vol_eavc <- EnhancedVolcano(N_EA_v_C_uniprot,
                lab = NA, 
                x = 'log2FoldChange', 
                y = 'padj', 
                pCutoff = 0.01, #pCutoff = 0.005,
                FCcutoff = 1.5, #FCcutoff = 1
                col = c('grey', 'pink','#00509d', '#bf0603'),
                title = 'EA vs. Control',
                subtitle = '',
                caption = '',
                xlim = c(-5, 5),
                ylim = c(0, 10),
                pointSize = 1,
                gridlines.major = F,
                gridlines.minor = F,
                legendPosition = 'none',
                legendLabSize = 10
  )
#statistics to add to plot quadrants
N_EA_v_C_uniprot %>% 
  summarise(
    dn_red = sum(log2FoldChange < -1.5 & padj <= 0.01),
    dn_pink = sum(log2FoldChange < -1.5 & padj >= 0.01),
    dn_blue = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj <= 0.01),
    dn_grey = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj >= 0.01),
    up_red = sum(log2FoldChange > 1.5 & padj <= 0.01),
    up_pink = sum(log2FoldChange > 1.5 & padj >= 0.01),
    up_blue = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj <= 0.01),
    up_grey = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj >= 0.01)
  )
```

Volcano plot of DEGs between naive CD4+ T cells of Early treated (EA) and Late treated (LA)
```{r}
# ENSEMBL annotation
ens2symbol <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_LA$row, 
                                    columns="SYMBOL",
                                    keytype="ENSEMBL")
# UNIPROT anno
ens2uniprot <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_LA$row,
                                    columns="UNIPROT",
                                    keytype="ENSEMBL")

# ENTREZ anno
ens2entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_EA_v_LA$row,
                                    columns="ENTREZID",
                                    keytype="ENSEMBL")

ens2symbol <- as_tibble(ens2symbol)
ens2uniprot <- as_tibble(ens2uniprot)
ens2entrez <- as_tibble(ens2entrez)


N_EA_v_LA <- inner_join(N_EA_v_LA, ens2symbol, by=c("row"="ENSEMBL"))
N_EA_v_LA <- N_EA_v_LA %>% na.omit()
N_EA_v_LA <- N_EA_v_LA[!duplicated(N_EA_v_LA$SYMBOL), ]

# PROTEIN CODING GENES
N_EA_v_LA_uniprot <- inner_join(N_EA_v_LA, ens2uniprot, by=c("row"="ENSEMBL"))
N_EA_v_LA_uniprot <- N_EA_v_LA_uniprot %>% na.omit()
N_EA_v_LA_uniprot <- N_EA_v_LA_uniprot[!duplicated(N_EA_v_LA_uniprot$SYMBOL), ]

# ENTREZ
N_EA_v_LA_entrez <- inner_join(N_EA_v_LA, ens2entrez, by=c("row"="ENSEMBL"))
N_EA_v_LA_entrez <- N_EA_v_LA_entrez %>% na.omit()
N_EA_v_LA_entrez <- N_EA_v_LA_entrez[!duplicated(N_EA_v_LA_entrez$SYMBOL), ]

vol_eavla <- EnhancedVolcano(N_EA_v_LA_uniprot,
                lab = NA, 
                x = 'log2FoldChange', 
                y = 'padj', 
                col = c('grey', 'pink','#00509d', '#bf0603'),
                pCutoff = 0.01, #pCutoff = 0.005,
                FCcutoff = 1.5, #FCcutoff = 1
                title = 'EA vs. LA',
                subtitle = '',
                caption = '',
                xlim = c(-5, 5),
                ylim = c(0, 10),
                pointSize = 1,
                gridlines.major = F,
                gridlines.minor = F,
                legendPosition = 'none',
                legendLabSize = 10
  )
#statistics to add to plot quadrants
N_EA_v_LA_uniprot %>% 
  summarise(
    dn_red = sum(log2FoldChange < -1.5 & padj <= 0.01),
    dn_pink = sum(log2FoldChange < -1.5 & padj >= 0.01),
    dn_blue = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj <= 0.01),
    dn_grey = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj >= 0.01),
    up_red = sum(log2FoldChange > 1.5 & padj <= 0.01),
    up_pink = sum(log2FoldChange > 1.5 & padj >= 0.01),
    up_blue = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj <= 0.01),
    up_grey = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj >= 0.01)
  )
```

Volcano plot of DEGs between naive CD4+ T cells of Late treated (LA) and controls (C)
```{r}
# ENSEMBL annotation
ens2symbol <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_LA_v_C$row, 
                                    columns="SYMBOL",
                                    keytype="ENSEMBL")
# UNIPROT anno
ens2uniprot <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_LA_v_C$row,
                                    columns="UNIPROT",
                                    keytype="ENSEMBL")

# ENTREZ anno
ens2entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    key=N_LA_v_C$row,
                                    columns="ENTREZID",
                                    keytype="ENSEMBL")

ens2symbol <- as_tibble(ens2symbol)
ens2uniprot <- as_tibble(ens2uniprot)
ens2entrez <- as_tibble(ens2entrez)


N_LA_v_C <- inner_join(N_LA_v_C, ens2symbol, by=c("row"="ENSEMBL"))
N_LA_v_C <- N_LA_v_C %>% na.omit()
N_LA_v_C <- N_LA_v_C[!duplicated(N_LA_v_C$SYMBOL), ]

# PROTEIN CODING GENES
N_LA_v_C_uniprot <- inner_join(N_LA_v_C, ens2uniprot, by=c("row"="ENSEMBL"))
N_LA_v_C_uniprot <- N_LA_v_C_uniprot %>% na.omit()
N_LA_v_C_uniprot <- N_LA_v_C_uniprot[!duplicated(N_LA_v_C_uniprot$SYMBOL), ]

# ENTREZ
N_LA_v_C_entrez <- inner_join(N_LA_v_C, ens2entrez, by=c("row"="ENSEMBL"))
N_LA_v_C_entrez <- N_LA_v_C_entrez %>% na.omit()
N_LA_v_C_entrez <- N_LA_v_C_entrez[!duplicated(N_LA_v_C_entrez$SYMBOL), ]

vol_lavc <- EnhancedVolcano(N_LA_v_C_uniprot,
                lab = NA, 
                x = 'log2FoldChange', 
                y = 'padj', 
                pCutoff = 0.01, #pCutoff = 0.005,
                FCcutoff = 1.5, #FCcutoff = 1
                col = c('grey', 'pink','#00509d', '#bf0603'),
                title = 'LA vs. Control',
                subtitle = '',
                caption = '',
                xlim = c(-5, 5),
                ylim = c(0, 10),
                pointSize = 1,
                gridlines.major = F,
                gridlines.minor = F,
                legendPosition = 'none',
                legendLabSize = 10
  )
#statistics to add to plot quadrants
N_LA_v_C_uniprot %>% 
  summarise(
    dn_red = sum(log2FoldChange < -1.5 & padj <= 0.01),
    dn_pink = sum(log2FoldChange < -1.5 & padj >= 0.01),
    dn_blue = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj <= 0.01),
    dn_grey = sum(log2FoldChange>-1.5 & log2FoldChange<0 & padj >= 0.01),
    up_red = sum(log2FoldChange > 1.5 & padj <= 0.01),
    up_pink = sum(log2FoldChange > 1.5 & padj >= 0.01),
    up_blue = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj <= 0.01),
    up_grey = sum(log2FoldChange < 1.5 & log2FoldChange > 0 & padj >= 0.01)
    
  )
```


Gene set enrichment analysis with fgsea
```{r}
# download up-to-date GO-BP genesets to create a gmt file
gs <- go.gsets(species = "human", pkg.name=NULL, id.type = "eg", keep.evidence=FALSE)
gs <- gs$go.sets[gs$go.subs$BP] # get only BP GOs
data(egSymb)
gs <- lapply(gs, gage::eg2sym)
writeGMT(gs, 'GO_file.gmt')

# load GO-BP gmt file
pathways <- gmtPathways("~/Downloads/BEA20P034_FC/DESeq/GO_file.gmt")

######################################
##### LA vs C geneset enrichment #####
######################################
data <- N_LA_v_C_uniprot
cells <- 'NTC'
ranking <- data %>% 
  dplyr::select(SYMBOL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(SYMBOL)
ranks <- deframe(ranking)
fgseaRes <- fgsea(pathways=pathways, stats=ranks, minSize = 1, maxSize = Inf)

gseaRes_LAvC <- fgseaRes %>%
  as_tibble() %>%
  arrange(dplyr::desc(NES))
gseaRes_LAvC <- gseaRes_LAvC %>% separate(pathway, c('GO_id', 'pathway'), '(?<=GO:\\d{7})(\\s)') #split into GO id and pathway

######################################
##### EA vs C geneset enrichment #####
######################################
data <- N_EA_v_C_uniprot
cells <- 'NTC'
ranking <- data %>% 
  dplyr::select(SYMBOL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(SYMBOL)

ranks <- deframe(ranking)

fgseaRes <- fgsea(pathways=pathways, stats=ranks, minSize = 1, maxSize = Inf)

gseaRes_EAvC <- fgseaRes %>%
  as_tibble() %>%
  arrange(dplyr::desc(NES))
gseaRes_EAvC <- gseaRes_EAvC %>% separate(pathway, c('GO_id', 'pathway'), '(?<=GO:\\d{7})(\\s)') #split into GO id and pathway

#######################################
##### EA vs LA geneset enrichment #####
#######################################
data <- N_EA_v_LA_uniprot
cells <- 'NTC'
ranking <- data %>% 
  dplyr::select(SYMBOL, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(SYMBOL)

ranks <- deframe(ranking)

fgseaRes <- fgsea(pathways=pathways, stats=ranks, minSize = 1, maxSize = Inf)

gseaRes_EAvLA <- fgseaRes %>%
  as_tibble() %>%
  arrange(dplyr::desc(NES))
gseaRes_EAvLA <- gseaRes_EAvLA %>% separate(pathway, c('GO_id', 'pathway'), '(?<=GO:\\d{7})(\\s)') #split into GO id and pathway
```



List all pathways with x number of significantly different genes
```{r}
sign = NULL
cutoff <- 0.05
for (p in gseaResTidy %>% dplyr::filter(padj<= cutoff) %>% pull(pathway)) {
  leading_edge <- gseaResTidy %>% filter(pathway %in% p) %>% pull(leadingEdge) %>% unlist()
  my_genes <- filter(data, SYMBOL %in% leading_edge, padj<= cutoff) %>%
    pull(row)
  
    if (length(my_genes)>2) {
      q <- data_frame(path = p, genes = length(my_genes), leadingEdge = length(leading_edge))
      sign = rbind(sign, q)
    }
}
sign <- as.data.frame(sign)
writexl::write_xlsx(sign, '~/Downloads/BEA20P034_FC/DESeq/pathways/N/LAvC/pathways.xlsx')
```


Euler diagram
```{r}
eavc <- N_EA_v_C_uniprot %>% dplyr::filter(padj<=0.01, abs(log2FoldChange) > 1.5) %>% na.omit() %>% pull(SYMBOL) 
lavc <- N_LA_v_C_uniprot %>% dplyr::filter(padj<=0.01, abs(log2FoldChange) > 1.5) %>% na.omit() %>%  pull(SYMBOL)
eavla <- N_EA_v_LA_uniprot%>% dplyr::filter(padj<=0.01, abs(log2FoldChange) > 1.5) %>% na.omit() %>%  pull(SYMBOL) 

################################################################################
################ Genes that are COMMON or UNIQUE in comparisons ################
################################################################################
overlap_all <- intersect(intersect(eavc,lavc),eavla)
overlap_EAvC_LAvC <- intersect(eavc, lavc)
overlap_EAvC_EAcLA <- intersect(eavc, eavla)
overlap_LAvC_EAcLA <- intersect(lavc, eavla)

unique_EAvC <- setdiff(eavc, c(lavc, eavla))
unique_LAvC <- setdiff(lavc, c(eavc, eavla))
unique_EAvLA <- setdiff(eavla, c(eavc, lavc))

genes <- c(A = length(unique_EAvC), B = length(unique_LAvC), C = length(unique_EAvLA),
           'A&B' = length(overlap_EAvC_LAvC), 
           'A&C' = length(overlap_EAvC_EAcLA),
           'A&B&C' = length(overlap_all),
           'B&C' = length(overlap_LAvC_EAcLA))
fit <- euler(genes)
plot(fit, quantities = T,
     fills = c('#87BCDE', '#FF7E6B', '#F4D35E'),
     labels = list(labels = c('EA vs. Control', 'LA vs. Control', 'EA vs. LA')
                   ))
```

Violin plot showing median fold-change difference of EA and LA realtive to controls
```{r}
N_EA_v_C_uniprot[['group']] <- 'EA'
N_LA_v_C_uniprot[['group']] <- 'LA'

N_EA_plus_LA <- rbind(N_EA_v_C_uniprot, N_LA_v_C_uniprot)

N_EA_plus_LA %>% 
  ggplot(aes(x=group, y = abs(log2FoldChange), fill = group)) +
  geom_violin(trim=FALSE, adjust = 1.5)+
  geom_boxplot(width=0.1, fill="white",
               outlier.shape = NA
               ) +
  xlab('') +
  ylab('Absolute log2FC') +
  # coord_flip() +
  ggthemes::scale_color_tableau(name=NULL) +
  ggthemes::scale_fill_tableau(name=NULL) +
  theme_ipsum() +  
  theme(
    legend.position = 'none'
  )
```


Heatmap of DEGs (adj. p < 0.01 and log2FC > 1.5)
```{r}
library(pheatmap)
library(RColorBrewer)
merged_data <- merge(N_EA_v_C_uniprot, N_LA_v_C_uniprot, by = 'row')
merged_data <- merge(merged_data, N_EA_v_LA_uniprot, by = 'row')

gseaRes_ <- rbind(gseaRes_EAvC, gseaRes_LAvC, gseaRes_EAvLA)
cells <- 'NTC'
cutoff <- 0.01


leading_edge <- gseaRes_ %>% 
  dplyr::filter(padj<0.01) %>%
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>%  
  unique()


my_genes <- merged_data %>% 
  dplyr::filter(padj.x <= cutoff | padj.y <= cutoff | padj <= cutoff,
                abs(log2FoldChange.x)>1.5 | abs(log2FoldChange.y)>1.5 | abs(log2FoldChange)>1.5) %>% # stricter threshold
  pull(row) %>% 
  unique()

my_genes_anno <- merged_data %>% 
  dplyr::filter(padj.x <= cutoff | padj.y <= cutoff | padj <= cutoff,
                abs(log2FoldChange.x)>1.5 | abs(log2FoldChange.y)>1.5 | abs(log2FoldChange)>1.5) %>% # stricter threshold
  dplyr::select(row, SYMBOL.x)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells) %>% 
  rownames_to_column('sample') %>% 
  mutate(condition = factor(condition, levels = c('Late.Treated', 'Early.Treated', 'Control'))) %>%  
  arrange(condition) 
mat <- assay(vsd)[my_genes, ids$sample]
mat <- mat - rowMeans(mat)

mat_cut_tree = mat
dim(mat)
anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Late.Treated = '#ef9472', Early.Treated = '#9277f1', Control = '#7bec96'))


#row annotation
row_pathways <- gseaRes_ %>% 
  unnest(leadingEdge)


# general search for genes involved in immune response processes
row_anno1 <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('immune', pathway)) %>% dplyr::mutate(pathway = 'immune system')

# general search for genes involved in inflammation
row_anno2 <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('inflam', pathway)) %>% dplyr::mutate(pathway = 'Inflammation')

# general search for apoptosis genes
row_anno3 <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('apop', pathway)) %>% dplyr::mutate(pathway = 'apoptotic signaling pathway')


#convert symbols to ensembl
row_anno1['row'] <- AnnotationDbi::mapIds(org.Hs.eg.db,
                                    keys = row_anno1$SYMBOL, 
                                    keytype ="SYMBOL",
                                    column = "ENSEMBL")
row_anno2['row'] <- AnnotationDbi::mapIds(org.Hs.eg.db,
                                         keys = row_anno2$SYMBOL, 
                                         keytype ="SYMBOL",
                                         column = "ENSEMBL")
row_anno3['row'] <- AnnotationDbi::mapIds(org.Hs.eg.db,
                                         keys = row_anno3$SYMBOL, 
                                         keytype ="SYMBOL",
                                         column = "ENSEMBL")


row_anno1 <- row_anno1[!duplicated(row_anno1$row),]
row_anno2 <- row_anno2[!duplicated(row_anno2$row),]
row_anno3 <- row_anno3[!duplicated(row_anno3$row),]
row_anno1 <- row_anno1 %>% dplyr::select(row, pathway)
row_anno2 <- row_anno2 %>% dplyr::select(row, pathway)
row_anno3 <- row_anno3 %>% dplyr::select(row, pathway)


row_anno <- merge(row_anno1, row_anno2, by = 'row', all = T) %>% merge(row_anno3, by ='row', all = T) %>% column_to_rownames('row')

row_anno_symbs <- row_anno %>% dplyr::mutate(symbols = AnnotationDbi::mapIds(org.Hs.eg.db,
                                                                             keys = rownames(row_anno), 
                                                                             keytype ="ENSEMBL",
                                                                             column = "SYMBOL"))


#### OLO method clustering
cl_cb_new <- function(hcl, mat){
  # Recalculate manhattan distances for reorder method
  dists <- dist(mat, method = "manhattan")

  # Perform reordering according to OLO method
  hclust_olo <- reorder(hcl, dists)
  return(hclust_olo)
}

breaksList = seq(-2, 2, by = 0.01)

### Rearrange mat colums with kmeans
  # cluster each annotation segment
  kmeans_la <- kmeans(t(scale(mat[,grep('K', colnames(mat))])), centers = 3, nstart = 20)$cluster %>% enframe() %>% arrange(value, name) %>% pull(name)
  kmeans_ea <- kmeans(t(scale(mat[,grep('EA', colnames(mat))])), centers = 3, nstart = 20)$cluster %>% enframe() %>% arrange(value, name) %>% pull(name)
  kmeans_c <- kmeans(t(scale(mat[,grep('K|EA', colnames(mat), invert = T)])), centers = 3, nstart = 20)$cluster %>% enframe() %>% arrange(value, name) %>% pull(name)
  
  # order of mat columns
  kmeans_mat <- c(kmeans_la, kmeans_ea, kmeans_c)
  

# number of genes
  dim(mat)
  # [1] 1134  39


heatmap <- pheatmap(mat[, kmeans_mat],
         clustering_distance_cols = "manhattan",
         clustering_callback = cl_cb_new,
         cutree_rows = 4,
         cluster_cols = F,
         breaks = breaksList,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
         annotation_col = anno,
         annotation_row = row_anno,
         show_colnames = F,
         show_rownames = T,
         annotation_colors = anno_colors[1],
         clustering_method = "ward.D2",
         cluster_rows = T,
         labels_row = my_genes_anno$SYMBOL,
         fontsize_row = 0.5,
         cellheight = 0.8,
         treeheight_row = 100,
         treeheight_col = 0,
         width = 6,
         border_color = NA
)
dev.off()
# annotated genes in the matrix
length(intersect(rownames(mat_cut_tree), rownames(row_anno)))
# [1] 211
```

Analysis of annotated genes (apoptosis, immune response and inflammation)
```{r}
# immune response annotated genes
length(intersect(rownames(mat), row_anno1$row))
immune_genes <- intersect(rownames(mat_cut_tree), row_anno1$row)
# [1] 153
N_EA_v_C_uniprot %>% dplyr::filter(row %in% immune_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 67
N_LA_v_C_uniprot %>% dplyr::filter(row %in% immune_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 109
N_EA_v_LA_uniprot %>% dplyr::filter(row %in% immune_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 21

# inflammation annotated
length(intersect(rownames(mat_cut_tree), row_anno2$row))
# [1] 56
inflam_genes <- intersect(rownames(mat_cut_tree), row_anno2$row)
N_EA_v_C_uniprot %>% dplyr::filter(row %in% inflam_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 24
N_LA_v_C_uniprot %>% dplyr::filter(row %in% inflam_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 37
N_EA_v_LA_uniprot %>% dplyr::filter(row %in% inflam_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 13

# apoptosis annotates
length(intersect(rownames(mat_cut_tree), row_anno3$row))
# [1] 71
apop_genes <- intersect(rownames(mat_cut_tree), row_anno3$row)
N_EA_v_C_uniprot %>% dplyr::filter(row %in% apop_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 36
N_LA_v_C_uniprot %>% dplyr::filter(row %in% apop_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 52
N_EA_v_LA_uniprot %>% dplyr::filter(row %in% apop_genes, padj <= cutoff, abs(log2FoldChange) > 1.5) # 7

## Exract clusters form heatmap and annotate with symbols, change 'k' to set number of clusters
clusters <- cutree(heatmap$tree_row, k = 4) %>% tibble::enframe(name = 'ENS', value = 'cluster') %>%
  dplyr::mutate(SYMBOL = mapIds(org.Hs.eg.db,
                                keys = ENS, 
                                keytype ="ENSEMBL",
                                column = "SYMBOL")) %>% 
  dplyr::mutate(ENTREZ = mapIds(org.Hs.eg.db,
                                keys = ENS, 
                                keytype ="ENSEMBL",
                                column = "ENTREZID"))

## take gene counts for each group from dds object
normalized_counts <- counts(dds, normalized=TRUE) %>% 
  data.frame(check.names = F) %>%
  rownames_to_column(var="gene") %>% 
  as_tibble() %>% 
  dplyr::select(contains('N')) %>% 
  tidyr::gather('sample', 'counts', -gene) %>% 
  dplyr::mutate(
    group = case_when(
      grepl('EA', sample) ~ 'EA',
      grepl('K', sample) ~ 'LA',
      grepl('^\\d\\d\\d_\\d', sample) ~ 'C')) %>% 
  dplyr::filter(gene %in% clusters$ENS) %>% full_join(clusters, by = c('gene' = 'ENS')) %>% 
  dplyr::mutate(counts = round(counts, 2))



## compare counts of annotated genes in clusters
annotated_genes_entrez <- mapIds(org.Hs.eg.db,
                                 keys = rownames(row_anno), 
                                 keytype ="ENSEMBL",
                                 column = "ENTREZID") %>% unname()
## plot
normalized_counts %>% group_by(group) %>% 
  dplyr::mutate(group = factor(group, levels = c('EA', 'LA', 'C')),
                counts = log10(counts+0.1)) %>%
  dplyr::filter(counts>0, ENTREZ %in% annotated_genes_entrez) %>% 
  ggplot(aes(x= group, y = counts, fill = group)) +
  # geom_jitter(position=position_jitter(0.2)) +
  geom_violin(trim = F, adjust = 1) +
  geom_boxplot(outlier.shape = NA, width = 0.1, fill = 'white') +
  labs(y = 'Log Normalized Counts', x= '') +
  ggthemes::scale_fill_tableau(name=NULL) +
  facet_wrap(~factor(cluster, levels = c(4,2,3,1)), nrow = 1) +
  theme_ipsum() +
  theme(legend.position = 'none') +
  geom_signif(comparisons = list(c("C", "EA"),
                                 c("C", "LA"),
                                 c("EA", "LA")), test = 't.test', color = 'black', 
              map_signif_level=TRUE, step_increase = 0.2)

########## Doplot profiles. 
# extract annotated genes from culusters
c_list <- list(X1 = clusters[clusters$cluster == 4,4] %>% dplyr::filter(ENTREZ %in% annotated_genes_entrez) %>% pull(ENTREZ) %>% unname(),
               X2 = clusters[clusters$cluster == 2,4] %>% dplyr::filter(ENTREZ %in% annotated_genes_entrez) %>% pull(ENTREZ) %>% unname(),
               X3 = clusters[clusters$cluster == 3,4] %>% dplyr::filter(ENTREZ %in% annotated_genes_entrez) %>% pull(ENTREZ) %>% unname(),
               X4 = clusters[clusters$cluster == 1,4] %>% dplyr::filter(ENTREZ %in% annotated_genes_entrez) %>% pull(ENTREZ) %>% unname()
               )


#### GO enrichment analysis
ck <- compareCluster(geneCluster = c_list, fun = "enrichGO", 
                     OrgDb = org.Hs.eg.db, 
                     keyType = 'ENTREZID', 
                     readable = T,
                     ont = "BP",
                     pAdjustMethod = "BH",
                     pvalueCutoff  = 0.01,
                     qvalueCutoff  = 0.05)

# generate dotplot
dotplot(clusterProfiler.dplyr::filter(ck, parse_ratio(GeneRatio) > 0.1))
# Save 7x7
```


Heatmap of apoptosis-related genes
```{r}
##### helpter functions
# Cluster purity function
# To compute purity , each cluster is assigned to the class which is most frequent in the cluster, and then the accuracy of this assignment is measured by counting the number of correctly assigned cases and dividing by number of total cases.
cluster.purity <- function(clusters, classes) {

  sum(apply(table(classes, clusters), 2, max)) / length(clusters)
}

hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()


cluster.purity(hc, cls)

#### OLO clustering
cl_cb_new <- function(hcl, new){
  # Recalculate manhattan distances for reorder method
  dists <- dist(mat, method = "manhattan")
  
  # Perform reordering according to OLO method
  hclust_olo <- reorder(hcl, dists)
  return(hclust_olo)
}
#####

# EA v C 
# Apoptotic pathway heatmap
data <- N_EA_v_C_uniprot
gseaRes <- gseaRes_EAvC
cells <- 'NTC'
comparison <- c('Early.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('apop', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()

apop_genes <- intersect(rownames(mat_cut_tree), row_anno3$row)

my_genes <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()
my_genes_anno <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)

mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')


breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6.6,
               height = 8,
               border_color = NA
)
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 = pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()
################## Importance
set.seed(123)
data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'C')) #!!!! change appropriately
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() fix
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v C important genes
apop_ImpList_EAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'APOP_importance_EA.pdf', width = 2.5, height = 3, scale = 1.2)

N_EA_v_C_uniprot %>% dplyr::filter(SYMBOL %in% apop_ImpList_EAvC) %>% view()


##################################################################################### EA v LA #####################################################################################
data <- N_EA_v_LA_uniprot
gseaRes <- gseaRes_EAvLA
cells <- 'NTC'
comparison <- c('Early.Treated', 'Late.Treated')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('apop', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()


apop_genes <- intersect(rownames(mat_cut_tree), row_anno3$row)

my_genes <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()
my_genes_anno <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Late.Treated = '#ef9472'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')



breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6,
               height = 8,
               border_color = NA
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 = pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()

################## Importance
set.seed(123)
data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'LA')) 
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() fix
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v LA important genes
apop_ImpList_EAvLA <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>%
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'APOP_importance_EAvLA.pdf', width = 2.5, height = 3, scale = 1.2)

N_EA_v_LA_uniprot %>% dplyr::filter(SYMBOL %in% apop_ImpList_EAvLA) %>% view()



########################################################################################### LA v C ###########################################################################################

data <- N_LA_v_C_uniprot
gseaRes <- gseaRes_LAvC 
cells <- 'NTC'
comparison <- c('Late.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('apop', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()

# have to generate cut_tree heatmap for t e matrix
apop_genes <- intersect(rownames(mat_cut_tree), row_anno3$row)

my_genes <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()
my_genes_anno <- data %>% dplyr::filter(row %in% apop_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Late.Treated = '#ef9472', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)
row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')



# dev.off()

breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               border_color = NA,
               width = 6,
               height = 8
)
dev.off()

hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 = pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()
################## Importance
set.seed(123)
data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('LA', 'C'))
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() fix
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# LA v C important genes
apop_ImpList_LAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'APOP_importance_LA.pdf', width = 2.5, height = 3, scale = 1.2)

```

Heatmap of inflammation-related genes
```{r}
# Inflammatory response heatmap
### helper functions
#font size
fsize <- function(x=length(my_genes)){
  n <- sqrt(x^-2)*350
  if (n>10) {
    n=10
  }
  return(n)
}

# Cluster purity function
cluster.purity <- function(clusters, classes) {
  
  sum(apply(table(classes, clusters), 2, max)) / length(clusters)
}

hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()


cluster.purity(hc, cls)

#### for better arrangement of cols
library(seriation)
cl_cb_new <- function(hcl, mat){
  # Recalculate manhattan distances for reorder method
  dists <- dist(mat, method = "manhattan")
  
  # Perform reordering according to OLO method
  hclust_olo <- reorder(hcl, dists)
  return(hclust_olo)
}

##################################################################################### EA v C #####################################################################################
data <- N_EA_v_C_uniprot
gseaRes <- gseaRes_EAvC #use GO_pathays of interest to generate
cells <- 'NTC'
comparison <- c('Early.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('inflam', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


# based on pathways containing "immune"
leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()

inflam_genes <- intersect(rownames(mat_cut_tree), row_anno2$row)

my_genes <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% # was GO_id
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')


breaksList = seq(-2, 2, by = 0.01)

p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_col = 3,
               main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6,
               height = 6,
               border_color = NA
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 = pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()
################## Importance

set.seed(123)
data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'C')) #!!!! change appropriately
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v C important genes
inflam_ImpList_EAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)

library(hrbrthemes)
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0, 10) +
  theme(panel.grid = element_blank()) +
  coord_flip()

  # ggsave(plot = last_plot(), device = 'pdf', 'INFLAM_importance_EA.pdf', width = 2.5, height = 3, scale = 1.2)
  

##################################################################################### EA v LA #####################################################################################
# Inflammatory response heatmap
data <- N_EA_v_LA_uniprot
gseaRes <- gseaRes_EAvLA 
cells <- 'NTC'
comparison <- c('Early.Treated', 'Late.Treated')
selection <- 'inflammatory response'
cutoff <- 0.01

leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>%  #pathways within search matching farancesca's list
  unique()

inflam_genes <- intersect(rownames(mat_cut_tree), row_anno2$row)

my_genes <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)


# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Late.Treated = '#ef9472'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')



breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_col = 3,
               cellheight = fsize(),
               main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6,
               height = 8,
               border_color = NA
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 = pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()
################## Importance
set.seed(123)

data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'LA')) #!!!! change appropriately
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v LA important genes
inflam_ImpList_EAvLA <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'INFLAM_importance_EAvLA.pdf', width = 2.5, height = 3, scale = 1.2)


########################################################################################### LA v C ###########################################################################################
# Inflammatory response heatmap
data <- N_LA_v_C_uniprot
gseaRes <- gseaRes_LAvC
cells <- 'NTC'
comparison <- c('Late.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('inflam', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()


inflam_genes <- intersect(rownames(mat_cut_tree), row_anno2$row)


my_genes <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% inflam_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)

# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Late.Treated = '#ef9472', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')



breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
         breaks = breaksList,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
         clustering_distance_cols = "manhattan",
         clustering_callback = cl_cb_new,
         annotation_col = anno,
         show_colnames = F,
         annotation_colors = anno_colors[1],
         clustering_method = "ward.D",
         cluster_rows = T,
         labels_row = my_genes_anno$SYMBOL,
         fontsize_row = fsize(),
         fontsize_col = 3,
         cellwidth = fsize(),
         cellheight = fsize(),
         main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
         treeheight_row = 0, 
         treeheight_col = 50,
         border_color = NA,
         width = 6,
         height = 8
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 <-  pheatmap(mat,
              breaks = breaksList,
              color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
              clustering_distance_cols = "manhattan",
              clustering_callback = cl_cb_new,
              annotation_col = anno,
              show_colnames = F,
              annotation_colors = anno_colors[1],
              clustering_method = "ward.D",
              cluster_rows = T,
              labels_row = my_genes_anno$SYMBOL,
              fontsize_col = 3,
              main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
              treeheight_row = 0, 
              treeheight_col = 50,
              width = 6,
              height = 6,
              border_color = NA
)
dev.off()
# This creates the annotation of importance ranked genes only
# Must run the boruta first and then come back 
imp_anno <- imps2 %>% rownames_to_column() %>% pull(rowname)
rows <- my_genes_anno %>% dplyr::mutate(SYMBOL = ifelse(SYMBOL %in% imp_anno, SYMBOL, NA))

dev.off()
################## Importance
set.seed(123)
# data_ <- data_my[, c(intersect(my_genes_anno$SYMBOL, names(data_my)), 'group')] # to exclude undefined column

data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('LA', 'C')) #!!!! change appropriately
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# LA v C important genes
inflam_ImpList_LAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>%
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'INFLAM_importance_LA.pdf', width = 2.5, height = 3, scale = 1.2)

```

Heatmap of genes involved in immune response
```{r}
# Cluster purity function
cluster.purity <- function(clusters, classes) {
  
  sum(apply(table(classes, clusters), 2, max)) / length(clusters)
}

hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()


cluster.purity(hc, cls)

#### for better arrangement of cols
cl_cb_new <- function(hcl, mat){
  # Recalculate manhattan distances for reorder method
  dists <- dist(mat, method = "manhattan")
  
  # Perform reordering according to OLO method
  hclust_olo <- reorder(hcl, dists)
  return(hclust_olo)
}

##################################################################################### EA v C #####################################################################################
# Immune response heatmap
data <- N_EA_v_C_uniprot
gseaRes <- gseaRes_EAvC
cells <- 'NTC'
comparison <- c('Early.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('immune', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()

immune_genes <- intersect(rownames(mat_cut_tree), row_anno1$row)

my_genes <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)


# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)


row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')


breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6.6,
               height = 8,
               border_color = NA
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 <- pheatmap(mat,
               filename = 'IMMUNE_EA.pdf',
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6.6,
               height = 8,
               border_color = NA
)
dev.off()
################## Importance
set.seed(123)
data_ <- data_my[, c(intersect(my_genes_anno$SYMBOL, names(data_my)), 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'C')) #!!!! change appropriately
boruta_output <- Boruta(x = data_[, intersect(my_genes_anno$SYMBOL, names(data_my)) != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v C important genes
immune_ImpList_EAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + 
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'IMMUNE_importance_EA.pdf', width = 2.5, height = 3, scale = 1.2)

##################################################################################### EA v LA #####################################################################################
data <- N_EA_v_LA_uniprot
gseaRes <- gseaRes_EAvLA 
cells <- 'NTC'
comparison <- c('Early.Treated', 'Late.Treated')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('immune', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()

immune_genes <- intersect(rownames(mat_cut_tree), row_anno1$row)

my_genes <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)


# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Early.Treated = '#9277f1', Late.Treated = '#ef9472'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')


breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               clustering_method = "ward.D",
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6,
               height = 8,
               border_color = NA
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('EA vs. LA,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               width = 6.6,
               height = 8,
               border_color = NA
)
dev.off()

################## Importance
set.seed(123)
# my_genes_anno <- my_genes_anno
# data_ <- data_my[, c(intersect(my_genes_anno$SYMBOL, names(data_my)), 'group')]

data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('EA', 'LA'))
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# EA v LA important genes
immune_ImpList_EAvLA <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


# theme_set(theme_bw(base_size = 12))
imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + #use d_top30 for top 30 proteins; size is 4x6
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()
# ggsave(plot = last_plot(), device = 'pdf', 'IMMUNE_importance_EAvLA.pdf', width = 2.5, height = 3, scale = 1.2)


########################################################################################### LA v C ###########################################################################################
data <- N_LA_v_C_uniprot
gseaRes <- gseaRes_LAvC 
cells <- 'NTC'
comparison <- c('Late.Treated', 'Control')
selection <- gseaRes %>% unnest(leadingEdge) %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge) %>% dplyr::filter(grepl('immune', pathway)) %>% pull(pathway) %>% unique()
cutoff <- 0.01


leading_edge <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  unnest(leadingEdge) %>%
  pull(leadingEdge) %>% 
  unique()



immune_genes <- intersect(rownames(mat_cut_tree), row_anno1$row)

my_genes <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  pull(row) %>% 
  unique()

my_genes_anno <- data %>% dplyr::filter(row %in% immune_genes) %>% 
  dplyr::filter(padj <= cutoff, abs(log2FoldChange) > 1.5) %>% 
  dplyr::select(row, SYMBOL)


# remove duplicated rows
my_genes_anno <- my_genes_anno[!duplicated(my_genes_anno$row), ]
my_genes_anno <- my_genes_anno %>% as_tibble %>% column_to_rownames(var = 'row')

vsd <- vst(dds)
ids <- metaData %>% dplyr::filter(cellType %in% cells, condition %in% comparison)
mat <- assay(vsd)[my_genes, rownames(ids)]
mat <- mat - rowMeans(mat)
dim(mat)

anno <- metaData %>% dplyr::filter(cellType %in% cells) %>% dplyr::rename(condition, group = condition) %>%  dplyr::select(group) 
anno_colors <- list(group = c(Late.Treated = '#ef9472', Control = '#7bec96'))

#row annotation
row_pathways <- gseaRes %>% 
  dplyr::filter(pathway %in% selection) %>% 
  dplyr::filter(padj < 0.01) %>% 
  unnest(leadingEdge)

row_pathways <- row_pathways %>% dplyr::arrange(leadingEdge, desc(size)) # desc, keeps the largest pathways

row_pathways <- row_pathways[!duplicated(row_pathways$leadingEdge),]
row_anno <- row_pathways %>% dplyr::select(pathway, leadingEdge) %>% dplyr::rename(SYMBOL = leadingEdge)
row_anno <- merge(row_anno, data, by = 'SYMBOL')
row_anno <- row_anno[!duplicated(row_anno$row),]
row_anno <- row_anno %>% dplyr::filter(row %in% my_genes) %>%  dplyr::select(row, pathway) %>% column_to_rownames('row')


breaksList = seq(-2, 2, by = 0.01)


p1 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               border_color = NA,
               width = 6,
               height = 8
)
dev.off()
hc = cutree(p1$tree_col, 2)
cls = anno %>% rownames_to_column('sample') %>% dplyr::filter(sample %in% p1$tree_col$labels) %>% dplyr::mutate(group = as.numeric(group)) %>% deframe()
p2 <- pheatmap(mat,
               breaks = breaksList,
               color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(length(breaksList)),
               clustering_distance_cols = "manhattan",
               clustering_callback = cl_cb_new,
               annotation_col = anno,
               show_colnames = F,
               annotation_colors = anno_colors[1],
               cluster_rows = T,
               labels_row = my_genes_anno$SYMBOL,
               fontsize_row = fsize(),
               fontsize_col = 3,
               cellwidth = fsize(),
               cellheight = fsize(),
               main = paste0('LA vs. C,', ' n = ', dim(mat)[1], ', cp = ',  round(cluster.purity(hc, cls), 2)),
               treeheight_row = 0, 
               treeheight_col = 50,
               border_color = NA,
               width = 6,
               height = 8
)
dev.off()

################## Importance
set.seed(123)
data_ <- data_my[, c(my_genes_anno$SYMBOL, 'group')] %>% 
  dplyr::filter(group %in% c('LA', 'C'))
boruta_output <- Boruta(x = data_[, my_genes_anno$SYMBOL != "group"], # protect() solution
                        y = data_$group, doTrace=0)
names(boruta_output)

# 3. Get significant variables including tentatives
boruta_signif <- getSelectedAttributes(boruta_output, withTentative = TRUE)
print(boruta_signif)  

# If you are not sure about the tentative variables being selected for granted, you can choose a TentativeRoughFix on boruta_output.
# Do a tentative rough fix
roughFixMod <- TentativeRoughFix(boruta_output)
boruta_signif <- getSelectedAttributes(roughFixMod)
print(boruta_signif)

# Variable Importance Scores
imps <- attStats(roughFixMod)
imps2 <-  imps[imps$decision != 'Rejected', c('meanImp', 'decision')]
imps2 <-  imps2[!row.names(imps2) %in% 'group', ]
head(imps2[order(-imps2$meanImp), ], 100)  # descending sort

# LA v C important genes
immune_ImpList_LAvC <- imps2 %>% dplyr::filter(meanImp >= 3) %>%  rownames_to_column() %>% pull(rowname)


imps2 %>% rownames_to_column() %>% dplyr::filter(meanImp >= 3) %>% 
  arrange(meanImp) %>% 
  mutate(name= factor(rowname, levels= rowname)) %>%
  ggplot(aes(y=meanImp, x= name)) + 
  geom_segment(aes(y = 0, x = name, yend = meanImp, xend = name)) + 
  geom_point(stat='identity', color="orange", size=2) +
  labs(x = '', y = 'Importance') +
  ggtitle('Feature importance') +
  theme_ipsum() +
  ylim(0,10) +
  theme(panel.grid = element_blank()) +
  coord_flip()

# ggsave(plot = last_plot(), device = 'pdf', 'IMMUNE_importance_LA.pdf', width = 2.5, height = 3, scale = 1.2)

```

Expression of genes of interest
```{r}
library(ggpubr)
gene <- c("ENSG00000073756", "ENSG00000171791", "ENSG00000160791", "ENSG00000126353", "ENSG00000139193", "ENSG00000178562", "ENSG00000112964", 
          "ENSG00000168685", "ENSG00000227507", "ENSG00000148773", "ENSG00000188389", "ENSG00000261371", "ENSG00000188404", "ENSG00000126561", "ENSG00000173757", 
          "ENSG00000117281", "ENSG00000163599", "ENSG00000181847", "ENSG00000135077", "ENSG00000186803", 
          "ENSG00000137757", "ENSG00000234829", "ENSG00000197919", "ENSG00000228083", "ENSG00000188379",
          "ENSG00000233816")
gene_symb <- mapIds(org.Hs.eg.db,
                        keys = gene, 
                        keytype ="ENSEMBL",
                        column = "SYMBOL")
gene_symb <- gene_symb[!gene_symb %in% c('CD28', 'PECAM1', 'STAT5A', 'CTLA4', 'HAVCR2', 'TIGIT')]

gene <- sort(unname(gene_symb))
gene <- mapIds(org.Hs.eg.db,
                        keys = gene, 
                        keytype ="SYMBOL",
                        column = "ENSEMBL")
gene <- unname(gene)

d_full = data_frame()
for (i in gene) {
  d = plotCounts(dds, gene= i, intgroup=c("condition", "cellType"), returnData = T) %>% dplyr::mutate(gene = i)
  d_full = rbind(d, d_full)
}


d_full %>% dplyr::filter(cellType %in% 'NTC') %>% dplyr::mutate(symbol =  AnnotationDbi::mapIds(org.Hs.eg.db,
                                keys = gene, 
                                keytype ="ENSEMBL",
                                column = "SYMBOL")) %>% 
ggplot(aes(x = factor(condition, levels = c('Early.Treated', 'Late.Treated', 'Control')), y = count, fill = factor(condition, levels = c('Early.Treated', 'Late.Treated', 'Control')))) +
  geom_boxplot() +
  scale_y_continuous(trans='log10', labels=trans_format('log10',math_format(10^.x))) +
  xlab('') +
  theme_ipsum() +
  facet_wrap(~symbol) +
  expand_limits(y = c(0, 100000)) +
  ggthemes::scale_fill_tableau(name=NULL) +
  theme(
    legend.position = 'none',
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_signif(comparisons = list(c("Control", "Early.Treated"),
                                 c("Control", "Late.Treated"),
                                 c("Early.Treated", "Late.Treated")), 
              map_signif_level=TRUE, step_increase = 0.1, textsize=2, size = 0.3)

# ggsave(plot = last_plot(), filename = 'all_genes2.pdf',
#        device = 'pdf', width = 6, height = 7, scale = 1.5)
```

Export network data for analysis with cytoscape (to identify hub genes)
```{r}
# helper function to export network data
export_network_to_graphml <- function (adj_mat, filename=NULL, weighted=TRUE,
                                       threshold=0.5, max_edge_ratio=3,
                                       nodeAttr=NULL, nodeAttrDataFrame=NULL,
                                       edgeAttributes=NULL, verbose=FALSE) {
  library('igraph')
  
  # Determine filename to use
  if (is.null(filename)) {
    filename='network.graphml'
  }
  
  
  # Adjust threshold if needed to limit remaining edges
  max_edges <- max_edge_ratio * nrow(adj_mat)
  
  edge_to_total_ratio <- max_edges / length(adj_mat)
  edge_limit_cutoff <- as.numeric(quantile(abs(adj_mat), 1 - edge_to_total_ratio))
  
  # Also choose a minimum threshold to make sure that at least some edges
  # are left
  min_threshold <- as.numeric(quantile(abs(adj_mat), 0.9999))
  
  threshold <- min(min_threshold, max(threshold, edge_limit_cutoff))
  
  # Remove edges with weights lower than the cutoff
  adj_mat[abs(adj_mat) < threshold] <- 0
  
  # Drop any genes with no edges
  orphaned <- (colSums(adj_mat) == 0)
  adj_mat <- adj_mat[!orphaned, !orphaned]
  
  # Also remove annotation entries
  if (!is.null(nodeAttr)) {
    nodeAttr <- nodeAttr[!orphaned]
  }
  if (!is.null(nodeAttrDataFrame)) {
    nodeAttrDataFrame <- nodeAttrDataFrame[!orphaned,]
  }
  
  # Keep track of non-positive edges and rescale to range 0,1
  is_zero     <- adj_mat == 0
  is_negative <- adj_mat < 0
  
  adj_mat <- (abs(adj_mat) - threshold) / (max(adj_mat) - threshold)
  adj_mat[is_zero] <- 0
  adj_mat[is_negative] <- -adj_mat[is_negative]
  
  if (verbose) {
    message(sprintf("Outputting matrix with %d nodes and %d edges", 
                    nrow(adj_mat), sum(adj_mat > 0)))
  }
  
  # Create a new graph and add vertices
  # Weighted graph
  if (weighted) {
    g <- graph.adjacency(adj_mat, mode='undirected', weighted=TRUE, diag=FALSE)
  } else {
    adj_mat[adj_mat != 0] <- 1
    g <- graph.adjacency(adj_mat, mode='undirected', diag=FALSE)
  }
  
  # Add single node annotation from vector
  if (!is.null(nodeAttr)) {
    g <- set.vertex.attribute(g, "attr", value=nodeAttr)
  }
  
  # Add node one or more node annotations from a data frame
  if (!is.null(nodeAttrDataFrame)) {
    for (colname in colnames(nodeAttrDataFrame)) {
      g <- set.vertex.attribute(g, colname, value=nodeAttrDataFrame[,colname])
    }
  }
  
  edge_correlation_negative <- c()
  
  # neg_correlations[edge_list]
  edge_list <- get.edgelist(g)
  
  for (i in 1:nrow(edge_list)) {
    from <- edge_list[i, 1]    
    to   <- edge_list[i, 2]    
  }
  
  # Save graph to a file
  write.graph(g, filename, format='graphml')
  
  # return igraph
  return(g)
}

##############                      ##############
##############      EA Analysis     ############## 
##############                      ##############

EAvC_DEG <- N_EA_v_C_uniprot %>% dplyr::filter(padj<= 0.01, abs(log2FoldChange) > 1.5) %>% pull(row)
EAvLA_DEG <- N_EA_v_LA_uniprot %>% dplyr::filter(padj<= 0.01, abs(log2FoldChange) > 1.5) %>% pull(row)
EA_DEG <- c(EAvC_DEG, EAvLA_DEG) %>% unique()
anno_genes_ensembl <- intersect(rownames(mat_cut_tree), rownames(row_anno))
EA_anno_genes <- intersect(EA_DEG, anno_genes_ensembl)
length(EA_anno_genes)
# >>112 genes

# annotated genes matrix
all_anno_EA <- counts(dds, normalized=TRUE) %>%
  data.frame(check.names = F) %>%
  dplyr::select(contains('N')) %>% 
  dplyr::select(matches('EA')) %>% 
  rownames_to_column(var="gene") %>% 
  dplyr::filter(gene %in% EA_anno_genes) %>% # EA annotated genes
  mutate(symbol= mapIds(org.Hs.eg.db,
                        keys = gene, 
                        keytype ="ENSEMBL",
                        column = "SYMBOL")) %>% 
  dplyr::select(!gene) %>% 
  distinct(symbol, .keep_all = T) %>% 
  column_to_rownames('symbol') %>% t()

# log transform
all_anno_EA <- log2(all_anno_EA+1)

matrixALL_anno_EA <- all_anno_EA # annotated genes


# Construct adjacency matrix for annonated genes
sq_EA <- matrixALL_anno_EA %>% correlate(use = 'complete.obs', method = 'spearman') %>% rearrange() %>% dplyr::select(!term)
adj_matrix_EA <- adjacency.fromSimilarity(as.matrix(sq_EA), power=12, type='signed')
adj_matrix_EA <- matrix(adj_matrix_EA, nrow=nrow(adj_matrix_EA))

rownames(adj_matrix_EA) <- colnames(matrixALL_anno_EA)
colnames(adj_matrix_EA) <- colnames(matrixALL_anno_EA)

adj_matrix_EA[is.na(adj_matrix_EA)] <- 1

g_EA_noMods <- export_network_to_graphml(adj_matrix_EA, filename='network_–ï–ê_annotated_0.5_noMods.graphml',
                               threshold=0.5)

##############                      ##############
##############      LA Analysis     ############## 
##############                      ##############

# annotated genes LA

LAvC_DEG <- N_LA_v_C_uniprot %>% dplyr::filter(padj<= 0.01, abs(log2FoldChange) > 1.5) %>% pull(row)
LA_DEG <- c(LAvC_DEG, EAvLA_DEG) %>% unique()
anno_genes_ensembl <- intersect(rownames(row_anno), rownames(mat))
LA_anno_genes <- intersect(LA_DEG, anno_genes_ensembl)
length(LA_anno_genes)
# >>176 genes

all_anno_LA <- counts(dds, normalized=TRUE) %>%
  data.frame(check.names = F) %>%
  dplyr::select(contains('N')) %>% 
  dplyr::select(matches('K')) %>% 
  rownames_to_column(var="gene") %>% 
  dplyr::filter(gene %in% LA_anno_genes) %>% # LA annotaed genes
  mutate(symbol= mapIds(org.Hs.eg.db,
                        keys = gene, 
                        keytype ="ENSEMBL",
                        column = "SYMBOL")) %>% 
  dplyr::select(!gene) %>% 
  distinct(symbol, .keep_all = T) %>% 
  column_to_rownames('symbol') %>% t()

# log transform
all_anno_LA <- log2(all_anno_LA+1)

matrixALL_anno_LA <- all_anno_LA # annotated genes


# Construct adjacency matrix for annonated genes

sq_LA <- matrixALL_anno_LA %>% correlate(use = 'complete.obs', method = 'spearman') %>% rearrange() %>% dplyr::select(!term)
adj_matrix_LA <- adjacency.fromSimilarity(as.matrix(sq_LA), power=12, type='signed')
adj_matrix_LA <- matrix(adj_matrix_LA, nrow=nrow(adj_matrix_LA))

rownames(adj_matrix_LA) <- colnames(matrixALL_anno_LA)
colnames(adj_matrix_LA) <- colnames(matrixALL_anno_LA)


adj_matrix_LA[is.na(adj_matrix_LA)] <- 1


g_LA_noMods <- export_network_to_graphml(adj_matrix_LA, filename='network_L–ê_annotated_0.5_noMods.graphml',
                                       threshold= 0.5)


##############                      ##############
##############      EA-LA Analysis  ############## 
##############                      ##############


EAvLA_DEG <- N_EA_v_LA_uniprot %>% dplyr::filter(padj<= 0.01, abs(log2FoldChange) > 1.5) %>% pull(row)
EAvLA_DEG <- EAvLA_DEG %>% unique()
anno_genes_ensembl <- intersect(rownames(row_anno), rownames(mat))
EAvLA_anno_genes <- intersect(EAvLA_DEG, anno_genes_ensembl)
length(EAvLA_anno_genes)
# >>30 genes

all_anno_EALA <- counts(dds, normalized=TRUE) %>%
  data.frame(check.names = F) %>%
  dplyr::select(contains('N')) %>% 
  dplyr::select(matches('EA')) %>% 
  rownames_to_column(var="gene") %>% 
  dplyr::filter(gene %in% EAvLA_anno_genes) %>% # LA annotaed genes
  mutate(symbol= mapIds(org.Hs.eg.db,
                        keys = gene, 
                        keytype ="ENSEMBL",
                        column = "SYMBOL")) %>% 
  dplyr::select(!gene) %>% 
  distinct(symbol, .keep_all = T) %>% 
  column_to_rownames('symbol') %>% t()

# log transform
all_anno_EALA <- log2(all_anno_EALA+1)


matrixALL_anno_EALA <- all_anno_EALA # annotated genes


# Construct adjacency matrix for annonated genes

sq_EALA <- matrixALL_anno_EALA %>% correlate(use = 'complete.obs', method = 'spearman') %>% rearrange() %>% dplyr::select(!term)
adj_matrix_EALA <- adjacency.fromSimilarity(as.matrix(sq_EALA), power=12, type='signed')
adj_matrix_EALA <- matrix(adj_matrix_EALA, nrow=nrow(adj_matrix_EALA))

rownames(adj_matrix_EALA) <- colnames(matrixALL_anno_EALA)
colnames(adj_matrix_EALA) <- colnames(matrixALL_anno_EALA)

adj_matrix_EALA[is.na(adj_matrix_EALA)] <- 1



g_EALA_noMods <- export_network_to_graphml(adj_matrix_EALA, filename='network_EAL–ê_annotated_0.5_noMods.graphml',
                                         threshold= 0.5)
#############################################################################################################
# hub gene table
############################################################################################################

########## hub genes enrichment analysis EA
analyzed_net <- read.csv('~/EA_annotated_0.5.csv')
hubs <- analyzed_net %>% 
  dplyr::filter(Degree >= 2) %>%
  dplyr::select(name, Degree) %>% 
  arrange(desc(Degree)) 

hubs_EA <- analyzed_net %>% dplyr::filter(Degree >= 2) %>% dplyr::select(name, Degree) %>% arrange(desc(Degree)) # Degree was > 1 in original
sif_EA <- read.delim('~/EA_annotated_0.5.sif', sep = '\t', header = F)
network <-sif_EA %>% dplyr::select(V1, V3)

# network with hubs
sif_EA %>% dplyr::filter(V1 %in% hubs_EA$name | V3 %in% hubs_EA$name) %>% write_tsv(., '~/EA_FC1.5_hubs.sif')


dbs <- c('GO_Biological_Process_2018')
hubGO <- data.frame(gene = NA,
                    GO = NA)

for (i in hubs$name) {
  
  networkSelect <- network %>% dplyr::filter(V1 %in% i | V3 %in% i) 
  networkSelect <- c(networkSelect$V1, networkSelect$V3) %>% unique()
  
  a <- as.data.frame(enrichR::enrichr(networkSelect, dbs))
  a <- a %>% dplyr::filter(GO_Biological_Process_2018.Adjusted.P.value <= 0.05) %>% 
    arrange(GO_Biological_Process_2018.Adjusted.P.value)
  # arrange(GO_Biological_Process_2018.Combined.Score)
  b <- sif_LA %>% dplyr::filter(V1 %in% i | V3  %in% i)
  b <- c(b$V1, b$V3) %>% unique()
  b <- b[b != i]
  b <- paste(b, collapse = ", ")
  temp = data.frame(gene = i,
                    GO = a[1,1],
                    nodes = b)
  temp = data.frame(gene = i,
                    GO = a[1,1])
  hubGO = rbind(temp, hubGO)
  
}

hubGO$GO <- gsub(' \\(GO:[0-9]+\\)', '', hubGO$GO)
hubGO[1:length(row.names(hubGO)) -1,] %>% view()

hub_table_ea <- hubs %>% left_join(hubGO, by = c('name' = 'gene')) %>% 
  dplyr::rename(gene = 'name') %>% 
  dplyr::rename(degree = 'Degree') %>% 
  relocate(gene) %>% 
  na.omit()



############ EA v LA
## hub genes enrichment analysis
analyzed_net <- read.csv('~/EAvLA_annotated_0.5.csv')
hubs <- analyzed_net %>% 
  dplyr::filter(Degree >= 2) %>%
  dplyr::select(name, Degree) %>% 
  arrange(desc(Degree))  # Degree was > 1 in original
  # head(5)

hubs_EALA <- analyzed_net %>% dplyr::filter(Degree >= 2) %>% dplyr::select(name, Degree) %>% arrange(desc(Degree)) # Degree was > 1 in original
sif_EALA <- read.delim('~/EAvLA_annotated_0.5.sif', sep = '\t', header = F)
network <-sif_EALA  %>% dplyr::select(V1, V3)

# network with hubs
sif_EALA %>% dplyr::filter(V1 %in% hubs_EALA$name | V3 %in% hubs_EALA$name) %>% write_tsv(., '~/EAvLA_FC1.5_hubs.sif')

dbs <- c('GO_Biological_Process_2018')
hubGO <- data.frame(gene = NA,
                    GO = NA)

# i = 'E2F1'
for (i in hubs$name) {
  
  networkSelect <- network %>% dplyr::filter(V1 %in% i | V3 %in% i) 
  networkSelect <- c(networkSelect$V1, networkSelect$V3) %>% unique()
  
  a <- as.data.frame(enrichR::enrichr(networkSelect, dbs))
  a <- a %>% dplyr::filter(GO_Biological_Process_2018.Adjusted.P.value <= 0.05) %>%
    arrange(GO_Biological_Process_2018.Adjusted.P.value)
  # arrange(GO_Biological_Process_2018.Combined.Score)
  b <- sif_LA %>% dplyr::filter(V1 %in% i | V3  %in% i)
  b <- c(b$V1, b$V3) %>% unique()
  b <- b[b != i]
  b <- paste(b, collapse = ", ")
  temp = data.frame(gene = i,
                    GO = a[1,1],
                    nodes = b)
  temp = data.frame(gene = i,
                    GO = a[1,1])
  hubGO = rbind(temp, hubGO)
  
}

hubGO$GO <- gsub(' \\(GO:[0-9]+\\)', '', hubGO$GO)
hubGO[1:length(row.names(hubGO)) -1,] %>% view()

hub_table_eala <- hubs %>% left_join(hubGO, by = c('name' = 'gene')) %>% 
  dplyr::rename(gene = 'name') %>% 
  dplyr::rename(degree = 'Degree') %>% 
  relocate(gene) %>% 
  na.omit()

# top hubs with WCGNA commands
# kin_EALA <- softConnectivity(adj_matrix_EALA)
# kin_hubs_EALA = (rank (-kin) <= 10) # top 10 hubs
# rownames(adj_matrix_EALA)[kin_hubs_EALA]


############ LA
## hub genes enrichment analysis
analyzed_net <- read.csv('~/LA_annoated_0.5.csv')
hubs <- analyzed_net %>% 
  dplyr::filter(Degree >= 2) %>%
  dplyr::select(name, Degree) %>% 
  arrange(desc(Degree))  # Degree was > 1 in original
# head(5)

hubs_LA <- analyzed_net %>% dplyr::filter(Degree >= 2) %>% dplyr::select(name, Degree) %>% arrange(desc(Degree)) # Degree was > 1 in original
sif_LA <- read.delim('~/LA_annoated_0.5.sif', sep = '\t', header = F)
network <-sif_LA  %>% dplyr::select(V1, V3)

# network with hubs
sif_LA %>% dplyr::filter(V1 %in% hubs_LA$name | V3 %in% hubs_LA$name) %>% write_tsv(., '~/LA_FC1.5_hubs.sif')


dbs <- c('GO_Biological_Process_2018')
hubGO <- data.frame(gene = NA,
                    GO = NA,
                    nodes = NA)

for (i in hubs$name) {
  
  networkSelect <- network %>% dplyr::filter(V1 %in% i | V3 %in% i) 
  networkSelect <- c(networkSelect$V1, networkSelect$V3) %>% unique()
  
  a <- as.data.frame(enrichR::enrichr(networkSelect, dbs))
  a <- a %>% dplyr::filter(GO_Biological_Process_2018.Adjusted.P.value <= 0.05) %>%
    arrange(GO_Biological_Process_2018.Adjusted.P.value)
  b <- sif_LA %>% dplyr::filter(V1 %in% i | V3  %in% i)
  b <- c(b$V1, b$V3) %>% unique()
  b <- b[b != i]
  b <- paste(b, collapse = ", ")
  temp = data.frame(gene = i,
                    GO = a[1,1],
                    nodes = b)
  hubGO = rbind(temp, hubGO)
  
}

hubGO$GO <- gsub(' \\(GO:[0-9]+\\)', '', hubGO$GO)
hubGO[1:length(row.names(hubGO)) -1,] %>% view()

hub_table_la <- hubs %>% left_join(hubGO, by = c('name' = 'gene')) %>% 
  dplyr::rename(gene = 'name') %>% 
  dplyr::rename(degree = 'Degree') %>% 
  relocate(gene) %>% 
  na.omit()



hubs_ea_10 <- hub_table_ea %>% dplyr::mutate(group = 'EAvC') %>% relocate(nodes, .after = group) %>% head(4)
hubs_la_10 <- hub_table_la %>%  dplyr::mutate(group = 'LAvC') %>% relocate(nodes, .after = group) %>%  head(4)
hubs_eala_10 <- hub_table_eala %>% dplyr::mutate(group = 'EAvLA') %>% relocate(nodes, .after = group) %>% head(1)

hubs_both <- rbind(hubs_ea_10, hubs_la_10, hubs_eala_10)
library(knitr)
library(rmarkdown)

table<-kable(hubs_both, format="markdown")
cat(table, sep="\n", file="table.Rmd")
render("table.Rmd",output_format = "pdf_document")
```

